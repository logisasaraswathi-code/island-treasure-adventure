<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Treasure Map Quest - Cinematic Island</title>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
<style>
body { margin:0; overflow:hidden; }
#ui { position:absolute; bottom:20px; width:100%; display:flex; justify-content:center; gap:10px; z-index:10; }
.btn { background:rgba(0,0,0,0.6); color:white; font-size:22px; padding:15px; border-radius:12px; user-select:none; }
#feedback { position:absolute; top:20px; width:100%; text-align:center; font-size:24px; font-weight:bold; color:white; text-shadow:2px 2px black; z-index:10; }
</style>
</head>
<body>

<div id="feedback"></div>
<div id="ui">
  <div class="btn" id="left">⬅</div>
  <div class="btn" id="right">➡</div>
  <div class="btn" id="up">⬆</div>
  <div class="btn" id="down">⬇</div>
  <div class="btn" id="jump">⤴</div>
</div>

<script>
let config = {
  type: Phaser.AUTO,
  width: window.innerWidth,
  height: window.innerHeight,
  physics: { default: 'arcade', arcade: { gravity: { y: 0 }, debug: false } },
  scene: { preload, create, update }
};

let game = new Phaser.Game(config);

let player, aiGroup, treasures, cursors = {}, particles;
let feedback = null;
let coins = 0;

function preload() {
  // Load cinematic images - YOU MUST HAVE REAL IMAGES
  this.load.image('bg_far','assets/bg_far.png');
  this.load.image('bg_mid','assets/bg_mid.png');
  this.load.image('bg_front','assets/bg_front.png');
  this.load.spritesheet('player','assets/player.png',{frameWidth:64,frameHeight:64});
  this.load.spritesheet('ai','assets/ai.png',{frameWidth:64,frameHeight:64});
  this.load.image('treasure','assets/treasure.png');
  this.load.image('spark','assets/spark.png');
  this.load.audio('bgm','assets/bgm.mp3');
}

function create() {
  feedback = document.getElementById("feedback");

  let music = this.sound.add('bgm',{ loop:true, volume:0.5 });
  music.play();

  // Cinematic parallax background layers
  this.bg_far = this.add.tileSprite(0,0,config.width,config.height,'bg_far').setOrigin(0);
  this.bg_mid = this.add.tileSprite(0,0,config.width,config.height,'bg_mid').setOrigin(0);
  this.bg_front = this.add.tileSprite(0,0,config.width,config.height,'bg_front').setOrigin(0);

  // Player
  player = this.physics.add.sprite(200,200,'player').setScale(1.5).setCollideWorldBounds(true);
  this.anims.create({key:'walk',frames:this.anims.generateFrameNumbers('player',{start:0,end:3}),frameRate:10,repeat:-1});

  // AI explorers
  aiGroup = this.physics.add.group();
  for(let i=0;i<3;i++){
    let ai = this.physics.add.sprite(Phaser.Math.Between(400,config.width-200),
                                     Phaser.Math.Between(100,config.height-200),
                                     'ai').setScale(1.5).setTint(0xff0000);
    this.anims.create({key:'aiWalk'+i,frames:this.anims.generateFrameNumbers('ai',{start:0,end:3}),frameRate:10,repeat:-1});
    ai.anims.play('aiWalk'+i,true);
    aiGroup.add(ai);
  }

  // Treasures
  treasures = this.physics.add.group();
  for(let i=0;i<5;i++){
    let t = this.physics.add.sprite(Phaser.Math.Between(100,config.width-100),
                                    Phaser.Math.Between(100,config.height-100),
                                    'treasure').setScale(0.5);
    treasures.add(t);
  }

  // Particle effects
  particles = this.add.particles('spark');

  // Overlap collection
  this.physics.add.overlap(player,treasures,collectTreasure,null,this);

  // Mobile buttons
  ['left','right','up','down','jump'].forEach(key=>{
    cursors[key]=false;
    document.getElementById(key).addEventListener('pointerdown',()=>cursors[key]=true);
    document.getElementById(key).addEventListener('pointerup',()=>cursors[key]=false);
  });

  // Camera follow
  this.cameras.main.startFollow(player,{ lerp:0.1, followOffset:{x:0,y:0} });
}

function update() {
  let speed = 200;
  player.setVelocity(0);

  if(cursors.left) player.setVelocityX(-speed);
  if(cursors.right) player.setVelocityX(speed);
  if(cursors.up) player.setVelocityY(-speed);
  if(cursors.down) player.setVelocityY(speed);
  if(cursors.jump && player.body.blocked.down) player.setVelocityY(-400);

  if(player.body.velocity.x!==0 || player.body.velocity.y!==0) player.anims.play('walk',true);
  else player.anims.stop();

  // AI random movement
  aiGroup.getChildren().forEach(ai=>{
    if(!ai.direction || Phaser.Math.Between(0,100)<2){
      ai.direction = {x:Phaser.Math.Between(-100,100), y:Phaser.Math.Between(-100,100)};
    }
    ai.setVelocity(ai.direction.x,ai.direction.y);
  });

  // Parallax movement
  this.bg_far.tilePositionX = this.cameras.main.scrollX*0.2;
  this.bg_mid.tilePositionX = this.cameras.main.scrollX*0.5;
  this.bg_front.tilePositionX = this.cameras.main.scrollX*0.8;
}

function collectTreasure(player, treasure) {
  treasure.disableBody(true,true);
  coins += Phaser.Math.Between(4000,10000);

  feedback.innerHTML = "✨ Treasure Collected! Coins: "+coins;
  feedback.style.color="gold";

  let emitter = particles.createEmitter({
    x: treasure.x,
    y: treasure.y,
    speed:{min:-200,max:200},
    lifespan:600,
    quantity:30,
    scale:{start:0.6,end:0}
  });

  setTimeout(()=>{ emitter.stop(); feedback.innerHTML=""; },1000);
}
</script>
</body>
</html>
